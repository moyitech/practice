# Carbon Auth 项目实现说明

## 一、项目概述

本项目实现了一个完整的认证服务系统（carbon-auth），包含用户登录、注册、忘记密码等核心功能。项目采用Spring Boot + MyBatis-Plus + Redis架构，重点实现了Redis缓存机制。

## 二、技术栈

### 核心框架
- **Spring Boot 2.6.13** - 应用基础框架
- **Spring Cloud 2021.0.5** - 微服务框架
- **Spring Cloud Alibaba 2021.0.4.0** - 微服务组件

### 数据层
- **MyBatis-Plus 3.5.2** - ORM框架，简化数据库操作
- **MySQL** - 关系型数据库
- **Redis** - 缓存数据库（重点）

### 消息队列
- **RocketMQ** - 异步消息处理

### 工具库
- **Hutool 5.8.11** - Java工具类库
- **JWT 0.9.1** - Token生成和验证
- **Swagger 2.9.2** - API文档

## 三、项目结构

```
carbon-auth/
├── main/
│   ├── java/com/carbon/auth/
│   │   ├── common/              # 公共类（ApiResult、ApiCode、ExpCodeEnum）
│   │   ├── config/              # 配置类（MyBatis、Swagger）
│   │   ├── constant/            # 常量类（Redis Key、账户状态等）
│   │   ├── controller/          # 控制器层（LoginController）
│   │   ├── entity/              # 实体类（SysAccount、BaseEntity）
│   │   ├── exception/           # 异常类（CommonBizException）
│   │   ├── mapper/              # Mapper接口（LoginMapper）
│   │   ├── param/               # 参数类（LoginParam、RegisterParam等）
│   │   ├── service/             # 服务层
│   │   │   ├── feign/           # Feign客户端（SystemServiceApi）
│   │   │   ├── impl/            # 服务实现类
│   │   │   └── 接口定义
│   │   ├── util/                # 工具类（JwtUtil、HttpContextUtils）
│   │   ├── vo/                  # 视图对象（LoginInfoVo、SecurityData）
│   │   └── CarbonAuthApplication.java
│   └── resources/
│       ├── mapper/system/       # MyBatis XML映射文件
│       ├── application.yml      # 主配置
│       └── application-dev.yml  # 开发环境配置
├── test/                        # 单元测试
├── sql/                         # 数据库脚本
├── postman/                     # Postman测试集合
├── pom.xml                      # Maven依赖
└── README.md                    # 项目说明
```

## 四、核心功能实现

### 4.1 用户登录（byLoginName）

**实现位置：** `LoginServiceImpl.java`

**业务流程：**

1. **参数验证**
   - 接收登录参数（账户名、密码）
   - 去除账户名前后空格

2. **账号查询**
   ```java
   SysAccount account = loginMapper.selectOne(
       Wrappers.lambdaQuery(SysAccount.class)
       .eq(SysAccount::getAccountName, accountName)
   );
   ```

3. **密码验证**
   ```java
   if (!account.getPassword().equals(DigestUtils.md5DigestAsHex(password.getBytes()))) {
       throw new CommonBizException(ExpCodeEnum.SYSTEM_SECURITY_USER_PASSWORD_ERROR);
   }
   ```

4. **账号状态检查**
   - 检查是否禁用
   - 检查是否未开户

5. **Redis缓存检查**
   ```java
   loginInfo = getLoginInfoByRedis(account.getId());
   if (null != loginInfo) {
       return loginInfo; // 已登录，直接返回
   }
   ```

6. **生成Token并缓存**
   ```java
   String token = JwtUtil.generateToken(account.getId(), account.getTenantId());
   loginInfo = new LoginInfoVo();
   loginInfo.setToken(token);
   loginInfo.setSecurityData(getSecurityData(account.getId()));
   saveLoginInfoByRedis(loginInfo);
   ```

### 4.2 用户注册（register）

**实现位置：** `LoginServiceImpl.java`

**业务流程：**

1. **验证码校验**
   ```java
   smsService.checkValidateCode(param.getPhone(), param.getCode(), RedisKeyName.SMS_REGISTER_KEY);
   ```

2. **密码一致性检查**
   ```java
   if (!param.getPassword().equals(param.getConfirmPassword())) {
       throw new CommonBizException(ExpCodeEnum.PASSWORD_NOT_SAME);
   }
   ```

3. **调用系统服务创建账号**
   ```java
   ApiResult<Boolean> result = systemServiceApi.addSysAccount(accountParam);
   ```

4. **发送MQ消息**
   ```java
   Message<OpenRegisterAccount> msg = MessageBuilder
       .withPayload(registerAccount).build();
   mqTemplate.syncSend(RocketMqName.OpenRegisterAccount_MSG, msg, 3000, RocketDelayLevelConstant.SECOND10);
   ```

### 4.3 忘记密码（forgotPassword）

**业务流程：**

1. 校验短信验证码
2. 验证两次密码是否一致
3. 根据手机号查询用户
4. 调用系统服务更新密码

### 4.4 退出登录（logout）

**业务流程：**

```java
public void logout(Long accountId) {
    removeLoginInfoByRedis(accountId);
}
```

直接删除Redis中的登录信息。

### 4.5 判断是否登录（isLogin）

**业务流程：**

1. 从请求头获取Token
2. 从Redis获取登录信息
3. 对比Token是否一致

```java
public Boolean isLogin(Long accountId) {
    String requestToken = HttpContextUtils.getRequestToken();
    LoginInfoVo loginInfo = getLoginInfoByRedis(accountId);
    if (null == loginInfo) {
        return false;
    }
    String redisToken = loginInfo.getToken();
    return !StrUtil.isEmpty(redisToken) && redisToken.equals(requestToken);
}
```

## 五、Redis缓存实现（重点）

### 5.1 Redis服务封装

**接口定义：** `RedisService.java`

```java
public interface RedisService {
    void set(String key, String value);
    void setEx(String key, String value, long timeout, TimeUnit timeUnit);
    String get(String key);
    void remove(String key);
    Boolean hasKey(String key);
}
```

**实现类：** `RedisServiceImpl.java`

使用Spring的`StringRedisTemplate`进行操作。

### 5.2 登录信息缓存

**Key设计：**
```java
public static final String LOGIN_USER = "login:user:%s";
```

**存储方法：**
```java
private void saveLoginInfoByRedis(LoginInfoVo loginInfoVo) {
    Long accountId = loginInfoVo.getSecurityData().getAccountId();
    redisService.setEx(
        String.format(CommonRedisKey.LOGIN_USER, accountId),
        JSONUtil.toJsonStr(loginInfoVo),
        JwtUtil.EXPIRE_SECOND,
        TimeUnit.SECONDS
    );
}
```

**获取方法：**
```java
private LoginInfoVo getLoginInfoByRedis(Long accountId) {
    String json = redisService.get(String.format(CommonRedisKey.LOGIN_USER, accountId));
    if (StrUtil.isEmpty(json)) {
        return null;
    }
    LoginInfoVo loginInfo = new Gson().fromJson(json, LoginInfoVo.class);
    // 校验redis中的token
    if (!JwtUtil.isValidToken(loginInfo.getToken())) {
        return null;
    }
    return loginInfo;
}
```

**删除方法：**
```java
private void removeLoginInfoByRedis(Long accountId) {
    redisService.remove(String.format(CommonRedisKey.LOGIN_USER, accountId));
}
```

**缓存数据结构：**
```json
{
  "token": "eyJhbGciOiJIUzUxMiJ9...",
  "securityData": {
    "accountId": 1,
    "accountName": "admin",
    "phone": "13800138000",
    "tenantId": 1,
    "roleCodes": ["admin"],
    "permissionCodes": ["/api/user/list"]
  }
}
```

### 5.3 验证码缓存

**Key设计：**
```java
// 注册验证码
public static final String SMS_REGISTER_KEY = "sms:register:%s";

// 忘记密码验证码
public static final String SMS_FORGOT_PASSWORD_KEY = "sms:forgot:password:%s";
```

**存储验证码：**
```java
public void sendRegisterCode(String phone) {
    String code = RandomUtil.randomNumbers(6);
    String key = String.format("sms:register:%s", phone);
    redisService.setEx(key, code, CODE_EXPIRE_MINUTES, TimeUnit.MINUTES);
    log.info("发送注册验证码到手机号: {}, 验证码: {}", phone, code);
}
```

**校验验证码：**
```java
public void checkValidateCode(String phone, String code, String redisKeyTemplate) {
    String key = String.format(redisKeyTemplate, phone);
    String savedCode = redisService.get(key);
    
    if (StrUtil.isEmpty(savedCode)) {
        throw new CommonBizException(ExpCodeEnum.SMS_CODE_ERROR.getCode(), "验证码已过期");
    }
    
    if (!savedCode.equals(code)) {
        throw new CommonBizException(ExpCodeEnum.SMS_CODE_ERROR);
    }
    
    // 验证通过后删除验证码
    redisService.remove(key);
}
```

**过期时间：** 5分钟

## 六、MyBatis数据查询实现

### 6.1 LoginMapper接口

**位置：** `com.carbon.auth.mapper.LoginMapper`

```java
@Repository
public interface LoginMapper extends BaseMapper<SysAccount> {
    SecurityData getSecurityDataAccountId(@Param("accountId") Long accountId);
}
```

### 6.2 LoginMapper.xml

**位置：** `resources/mapper/system/LoginMapper.xml`

**核心SQL：**
```xml
<select id="getSecurityDataAccountId" resultType="com.carbon.auth.vo.SecurityData">
    select sa.id accountId,
           sa.phone,
           sa.avatar,
           sa.account_name,
           sa.tenant_id,
           ifnull(group_concat(sr.role_code),'') roleCodeStr,
           ifnull(group_concat(sp.uri),'') permissionCodesStr,
           st.tenant_name,
           st.contacts_phone

    from sys_account sa
    left join sys_account_role sar on sar.account_id = sa.id
    left join sys_role sr on sr.id = sar.role_id
    left join sys_role_permission srp on srp.role_id = sar.role_id
    left join sys_permission sp on sp.id = srp.permission_id
    left join sys_tenant st on st.id = sa.tenant_id

    where sa.id = #{accountId}
    group by sa.id
</select>
```

**查询说明：**
- 查询账号基本信息
- 关联查询角色信息
- 关联查询权限信息
- 关联查询租户信息
- 使用`group_concat`聚合角色和权限

## 七、JWT Token实现

### 7.1 JwtUtil工具类

**位置：** `com.carbon.auth.util.JwtUtil`

**生成Token：**
```java
public static String generateToken(Long accountId, Long tenantId) {
    Date now = new Date();
    Date expireDate = new Date(now.getTime() + EXPIRE_SECOND * 1000);

    Map<String, Object> claims = new HashMap<>();
    claims.put("accountId", accountId);
    claims.put("tenantId", tenantId);

    return Jwts.builder()
            .setClaims(claims)
            .setIssuedAt(now)
            .setExpiration(expireDate)
            .signWith(SignatureAlgorithm.HS512, SECRET)
            .compact();
}
```

**验证Token：**
```java
public static boolean isValidToken(String token) {
    try {
        Claims claims = parseToken(token);
        if (claims == null) {
            return false;
        }
        Date expiration = claims.getExpiration();
        return expiration.after(new Date());
    } catch (Exception e) {
        return false;
    }
}
```

**Token有效期：** 7天

## 八、API接口说明

### 8.1 登录接口

**URL：** `POST /auth/login`

**请求参数：**
```json
{
  "accountName": "admin",
  "password": "123456"
}
```

**返回结果：**
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "token": "eyJhbGciOiJIUzUxMiJ9...",
    "securityData": {
      "accountId": 1,
      "accountName": "admin",
      "phone": "13800138000",
      "tenantId": 1,
      "roleCodes": ["admin"],
      "permissionCodes": ["/api/user/list"]
    }
  }
}
```

### 8.2 注册接口

**URL：** `POST /auth/register`

**请求参数：**
```json
{
  "accountName": "newuser",
  "password": "123456",
  "confirmPassword": "123456",
  "phone": "13800138000",
  "email": "newuser@example.com",
  "code": "123456"
}
```

### 8.3 其他接口

- `GET /auth/logout` - 退出登录
- `GET /auth/register/code/{phone}` - 获取注册验证码
- `POST /auth/forgotPassword` - 忘记密码
- `GET /auth/forgotPassword/code/{phone}` - 获取忘记密码验证码
- `GET /auth/verify/{accountName}` - 验证账户是否存在

## 九、单元测试

### 9.1 LoginMapperTest

测试MyBatis数据查询功能：
```java
@Test
public void testGetSecurityDataAccountId() {
    Long accountId = 1L;
    SecurityData securityData = loginMapper.getSecurityDataAccountId(accountId);
    log.info("账户ID: {}", securityData.getAccountId());
    log.info("账户名: {}", securityData.getAccountName());
}
```

### 9.2 LoginServiceTest

测试业务逻辑：
```java
@Test
public void testByLoginName() {
    LoginParam loginParam = new LoginParam();
    loginParam.setAccountName("admin");
    loginParam.setPassword("123456");
    LoginInfoVo loginInfo = loginService.byLoginName(loginParam);
    log.info("Token: {}", loginInfo.getToken());
}
```

### 9.3 JwtUtilTest

测试JWT工具类：
```java
@Test
public void testGenerateToken() {
    String token = JwtUtil.generateToken(1L, 1L);
    log.info("Token: {}", token);
}
```

## 十、数据库设计

### 10.1 核心表结构

**sys_account - 系统账号表**
- id: 主键
- account_name: 账户名（唯一）
- phone: 手机号
- email: 邮箱
- password: 密码（MD5加密）
- account_status: 账户状态（1-启用 0-禁用 2-未开户）
- tenant_id: 租户ID

**sys_tenant - 租户表**
- id: 主键
- tenant_name: 租户名称
- contacts_phone: 联系电话

**sys_role - 角色表**
- id: 主键
- role_code: 角色编码
- role_name: 角色名称

**sys_permission - 权限表**
- id: 主键
- permission_code: 权限编码
- uri: 权限URI

**sys_account_role - 账号角色关联表**
**sys_role_permission - 角色权限关联表**

## 十一、配置说明

### 11.1 application.yml

```yaml
server:
  port: 9091

spring:
  application:
    name: carbon-auth
```

### 11.2 application-dev.yml

```yaml
spring:
  datasource:
    druid:
      url: jdbc:mysql://127.0.0.1:3306/carbon
      username: root
      password: your_password
  
  redis:
    host: 127.0.0.1
    port: 6379
  
  cloud:
    nacos:
      discovery:
        server-addr: http://127.0.0.1:8848

rocketmq:
  name-server: 127.0.0.1:9876
```

## 十二、启动步骤

1. **安装依赖环境**
   - MySQL 5.7+
   - Redis 5.0+
   - RocketMQ 4.9+
   - Nacos 2.0+

2. **初始化数据库**
   ```bash
   mysql -u root -p < sql/init.sql
   ```

3. **修改配置文件**
   - 修改`application-dev.yml`中的数据库密码
   - 确认Redis、Nacos、RocketMQ地址

4. **启动服务**
   ```bash
   mvn clean package
   java -jar target/carbon-auth-1.0.0.jar
   ```

5. **访问Swagger文档**
   - http://localhost:9091/swagger-ui.html

## 十三、项目亮点

1. **Redis缓存优化**
   - 登录信息缓存，减少数据库查询
   - 验证码缓存，提高验证效率
   - 合理的过期时间设置

2. **JWT Token认证**
   - 无状态认证
   - Token自动过期
   - 支持分布式部署

3. **MyBatis-Plus优化**
   - Lambda表达式查询
   - 自动填充
   - 逻辑删除

4. **微服务架构**
   - Nacos服务注册与发现
   - Feign远程调用
   - RocketMQ异步消息

5. **完善的异常处理**
   - 统一异常处理
   - 友好的错误提示

## 十四、总结

本项目完整实现了认证服务的核心功能，重点展示了：

1. **Redis缓存的使用**：登录信息缓存、验证码缓存
2. **MyBatis数据查询**：多表关联查询、聚合函数使用
3. **JWT Token认证**：Token生成、验证、过期处理
4. **微服务架构**：服务注册、远程调用、消息队列

项目代码结构清晰，注释完善，可以直接运行和测试。





